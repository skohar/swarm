{
  "builders": [
    {
      "type": "amazon-ebs",
      "source_ami": "ami-d05e75b8",
      "instance_type": "t2.micro",
      "region": "us-east-1",
      "ssh_username": "ubuntu",
      "ami_name": "whale-{{isotime \"2006-01-02_15-04-05"}}",
      "vpc_id": "vpc-55238031",
      "subnet_id": "subnet-ead3e6c1",
      "iam_instance_profile": "packerRole",
      "launch_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_size": 30,
          "delete_on_termination": true
        }
      ]
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sleep 30",
        "sudo apt-add-repository -y ppa:ansible/ansible",
        "sudo apt-get update",
        "sudo apt-get install -y ansible",
        "sudo apt-get install -y python-pip",
        "sudo pip install awscli"
      ]
    },
    {
      "type": "shell",
      "inline_shebang": "/bin/bash -e",
      "inline": [
        "aws s3 cp s3://code-check-config-packer/env.json .",
        "mv env.json /tmp"
      ]
    },
    {
      "type": "ansible-local",
      "command": "ansible-playbook",
      "playbook_file": "{{template_dir}}/playbook.yml",
      "playbook_dir": "{{template_dir}}",
      "inventory_file": "{{template_dir}}/inventories/aws",
      "extra_arguments": [
        "--extra-vars",
        "@/tmp/env.json"
      ]
    }
  ]
}
